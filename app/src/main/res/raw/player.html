<!DOCTYPE html>
<html>
<body>
<div style="display:none">
    <audio id="aid" controls ontimeupdate="updateTime(this)" loop>
        <source id="asrc" type="audio/mp3">
    </audio>

</div>
<script src="./socketio_1_4_5.js"></script>

<script>
var aid = document.getElementById("aid");
var asrc = document.getElementById("asrc");
var socket = null;
var delta = 0.0;
var server_movie_time = null;
var pre_cinema_id = null;
var current_cinema_id = null;
init();
function play(audio_src) {
    AndroidFunction.jsLog("audio_src********************");
    AndroidFunction.jsLog(audio_src);
    //aid.play();
    asrc.src = audio_src;
    aid.load();
    aid.play();
    aid.muted = true;
}
function pause() {
    aid.pause();
}
function mute(){
    aid.muted = true;
}
function unmute(){
    aid.muted = false;
}
function updateTime(event){
    AndroidFunction.updateTime(parseInt(event.currentTime), parseInt(event.duration));
}
function releaseSocketIO(){
    socket.disconnect();
    AndroidFunction.jsLog("yes release");
}
function init(){
    //var socket = io.connect("__CONNECT_HOST__");
    AndroidFunction.jsLog(AndroidFunction.getConnectHost());
    AndroidFunction.jsLog(AndroidFunction.getCinemaId());
    //var connect_host = AndroidFunction.getConnectHost();
    var cinema_id = AndroidFunction.getCinemaId();
    socket = io.connect(AndroidFunction.getConnectHost());
    socket.on('connect', function(json) {
              delta = (new Date()).getTime()/1000;
              socket.emit('sync');
console.log("connect");
              });
    socket.on('sync', function(json) {
console.log("sync");
              delta = json.server_time - (delta + (new Date()).getTime()/1000)/2;
              var join = {
                    cinema: {
                    //id: "__CINEMA_ID__"
                    id:cinema_id
                    }
              };
                    socket.emit('join', join);
                    console.log("join");
                    console.log(JSON.stringify(join));
                    console.log(socket);
                    console.log(socket === null);
              });
    socket.on('current-time', function(json) {
              //aid.muted = false;
              //server time + expected server current time - server player time
              var server_movie_time = json.current_time + (((new Date()).getTime()/1000) + delta) - json.server_time;
              // 將音軌時間調整至 server_movie_time
              if (aid.paused === false) {
                if (Math.abs(server_movie_time - aid.currentTime) <= 0.25) {
                    return;
                }
                aid.currentTime = server_movie_time;
               }
    });
     socket.on('movie-changed', function() {
               AndroidFunction.movieChanged();
     });
     socket.on('cinema-close', function() {
               // 放映結束應離開撥放器
               aid.pause();
               // AndroidFunction.jsLog('cinema-close');
     });
     AndroidFunction.init_socketIO_success();
}
</script>


</body>
</html>
